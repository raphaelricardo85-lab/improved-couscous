import streamlit as st
import pncp_backend  # nosso backend com toda a l√≥gica

# ============================================================
# ‚öôÔ∏è CONFIGURA√á√ÉO B√ÅSICA DA P√ÅGINA
# ============================================================

st.set_page_config(
    page_title="Pesquisa de Pre√ßos PNCP ‚Äì Lei 14.133/2021",
    layout="wide",
)

# Caminho do arquivo de imagem na pasta principal do projeto
LOGO_PATH = "logos_fortfisc_fundoamazonia.png"

# Pequeno ajuste visual no fundo e nos t√≠tulos (CSS leve)
st.markdown(
    """
    <style>
    .main {
        background-color: #f7f9fc;
    }
    .pncp-header {
        padding: 0.5rem 0 1rem 0;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 1rem;
    }
    .pncp-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        background-color: #e6f2ff;
        color: #003366;
        font-size: 0.8rem;
        margin-top: 0.2rem;
    }
    .pncp-help-box {
        background-color: #ffffff;
        border-radius: 0.5rem;
        padding: 0.8rem 1rem;
        border: 1px solid #e0e0e0;
        font-size: 0.9rem;
    }
    </style>
    """,
    unsafe_allow_html=True,
)

# ============================================================
# üß© CABE√áALHO COM LOGO
# ============================================================

st.markdown('<div class="pncp-header">', unsafe_allow_html=True)

# Duas colunas: logo √† esquerda, t√≠tulo √† direita
col_logo, col_titulo = st.columns([1, 3])

with col_logo:
    # A imagem est√° na mesma pasta do streamlit_app.py
    # Se n√£o aparecer, confira o nome/ extens√£o do arquivo
    st.image(LOGO_PATH, use_column_width=True)

with col_titulo:
    st.title("Pesquisa de Pre√ßos PNCP ‚Äì Lei 14.133/2021")

    st.markdown(
        "Aplica√ß√£o para pesquisa de pre√ßos no PNCP, "
        "com gera√ß√£o de planilha Excel e nota t√©cnica em HTML."
    )

    st.markdown(
        "_Projeto desenvolvido pela Coordena√ß√£o de Assuntos Estrat√©gicos de Prote√ß√£o Ambiental - Copes/Dipro/Ibama_"
    )

    st.markdown(
        '<span class="pncp-badge">Janela temporal: √∫ltimos 12 meses de inclus√£o no PNCP</span>',
        unsafe_allow_html=True,
    )

st.markdown("</div>", unsafe_allow_html=True)

# ============================================================
# üß± LAYOUT PRINCIPAL ‚Äì DUAS COLUNAS
# ============================================================

col_filtros, col_ajuda = st.columns([2, 1])

# ------------------------------------------------------------
# üßÆ COLUNA ESQUERDA ‚Äì FORMUL√ÅRIO DE FILTROS
# ------------------------------------------------------------
with col_filtros:
    with st.form("filtros_pncp"):
        st.subheader("Configura√ß√£o da pesquisa")

        # ---------------- Filtros principais ----------------
        with st.expander("Filtros principais", expanded=True):
            cod_item_str = st.text_input(
                "C√≥digo do item de cat√°logo (CATMAT/CATSER) ‚Äì opcional",
                placeholder="Ex.: 279727",
                help="Informe o c√≥digo do item de cat√°logo, se quiser restringir a pesquisa a um item espec√≠fico.",
            )
            orgao_cnpj = st.text_input(
                "CNPJ do √≥rg√£o ‚Äì opcional",
                value="",
                placeholder="Ex.: 00394494000136",
                help="N√∫mero do CNPJ da entidade do √≥rg√£o (somente n√∫meros).",
            )
            unidade_orgao = st.text_input(
                "C√≥digo da unidade do √≥rg√£o ‚Äì opcional",
                value="",
                placeholder="Ex.: 200350",
                help="C√≥digo da unidade do √≥rg√£o respons√°vel pela contrata√ß√£o.",
            )
            situacao_item = st.text_input(
                "Situa√ß√£o do item ‚Äì opcional",
                value="",
                placeholder="Ex.: 4 para 'Deserto'",
                help="C√≥digo da situa√ß√£o do item da compra (ex.: 4 = Deserto, 3 = Fracassado etc.).",
            )

            material_ou_servico = st.selectbox(
                "Material ou Servi√ßo",
                options=['(sem filtro)', "Material (M)", "Servi√ßo (S)"],
                index=0,
                help="Selecione se deseja restringir a pesquisa apenas a materiais (M) ou servi√ßos (S).",
            )

        # ---------------- Filtros avan√ßados ----------------
        with st.expander("Filtros avan√ßados (opcionais)", expanded=False):
            col1, col2, col3 = st.columns(3)
            with col1:
                codigo_classe_str = st.text_input(
                    "C√≥digo da classe ‚Äì opcional",
                    value="",
                    placeholder="Ex.: 6510",
                    help="C√≥digo da classe no cat√°logo de materiais/servi√ßos.",
                )
            with col2:
                codigo_grupo_str = st.text_input(
                    "C√≥digo do grupo ‚Äì opcional",
                    value="",
                    placeholder="Ex.: 01",
                    help="C√≥digo do grupo no cat√°logo.",
                )
            with col3:
                cod_fornecedor = st.text_input(
                    "C√≥digo do fornecedor ‚Äì opcional",
                    value="",
                    placeholder="Ex.: c√≥digo interno do fornecedor",
                )

            preco_max_str = st.text_input(
                "Pre√ßo m√°ximo da contrata√ß√£o (R$) ‚Äì opcional",
                value="",
                placeholder="Ex.: 150000.00",
                help="Filtra resultados com pre√ßo total da contrata√ß√£o abaixo ou igual a este valor.",
            )

            col4, col5, col6 = st.columns(3)
            with col4:
                tem_resultado_opt = st.selectbox(
                    "Filtrar por 'temResultado'?",
                    options=['(n√£o filtrar)', "Somente com resultado", "Somente sem resultado"],
                    index=0,
                    help="Filtra itens que possuem (ou n√£o) resultado registrado.",
                )
            with col5:
                bps_opt = st.selectbox(
                    "Filtrar BPS?",
                    options=['(n√£o filtrar)', "Somente BPS verdadeiro", "Somente BPS falso"],
                    index=0,
                    help="Filtra se a compra segue (ou n√£o) Boas Pr√°ticas de Suprimentos.",
                )
            with col6:
                mpn_opt = st.selectbox(
                    "Filtrar margem de prefer√™ncia normal?",
                    options=['(n√£o filtrar)', "Somente com margem", "Somente sem margem"],
                    index=0,
                    help="Filtra compras com aplica√ß√£o de margem de prefer√™ncia normal.",
                )

            codigo_ncm = st.text_input(
                "C√≥digo NCM ‚Äì opcional",
                value="",
                placeholder="Ex.: 30049099",
                help="C√≥digo NCM ‚Äì Nomenclatura Comum do Mercosul.",
            )

        # ---------------- Nome base dos arquivos ----------------
        nome_base = st.text_input(
            "Nome base dos arquivos de sa√≠da ‚Äì opcional",
            value="",
            placeholder="Ex.: pesquisa_algodao_2024",
            help="Se informado, ser√° usado como prefixo do nome da planilha e da nota t√©cnica.",
        )

        executar = st.form_submit_button("üîé Executar pesquisa")

# ------------------------------------------------------------
# üìñ COLUNA DIREITA ‚Äì AJUDA, PASSO A PASSO, OBSERVA√á√ïES
# ------------------------------------------------------------
with col_ajuda:
    st.subheader("Como utilizar")

    st.markdown(
        """
        <div class="pncp-help-box">
        <ol style="padding-left: 1.2rem;">
          <li>Preencha, se desejar, o <strong>item de cat√°logo</strong> ou a <strong>classe</strong>.</li>
          <li>Inclua filtros por <strong>CNPJ</strong>, unidade ou situa√ß√£o do item, se necess√°rios.</li>
          <li>Clique em <strong>‚ÄúExecutar pesquisa‚Äù</strong>.</li>
          <li>Baixe a <strong>planilha Excel</strong> e/ou a <strong>nota t√©cnica em HTML</strong>.</li>
          <li>Anexe os arquivos ao processo (SEI) como evid√™ncia da pesquisa de pre√ßos.</li>
        </ol>
        </div>
        """,
        unsafe_allow_html=True,
    )

    st.markdown("### Observa√ß√µes importantes")
    st.markdown(
        """
        - O per√≠odo considerado √© sempre de **12 meses para tr√°s** a partir da data atual.
        - Se nenhum dado for encontrado, ainda assim ser√° gerada uma **nota t√©cnica**
          registrando a tentativa de pesquisa e os filtros utilizados.
        - Filtros deixados em branco **n√£o s√£o enviados** √† API (n√£o restringem a consulta).
        """
    )

# ============================================================
# üß† FUN√á√ïES AUXILIARES (FRONTEND)
# ============================================================

def _parse_float_or_none(text, campo_nome):
    """
    Converte texto em float, ou retorna None.
    Em caso de erro, mostra um aviso leve na interface.
    """
    text = text.strip().replace(",", ".")
    if not text:
        return None
    try:
        return float(text)
    except ValueError:
        st.warning(f"Valor inv√°lido em '{campo_nome}'. Ignorando este filtro.")
        return None

def _parse_int_or_none(text, campo_nome):
    """
    Converte texto em int, ou retorna None.
    Em caso de erro, mostra um aviso leve na interface.
    """
    text = text.strip()
    if not text:
        return None
    try:
        return int(text)
    except ValueError:
        st.warning(f"Valor inv√°lido em '{campo_nome}'. Ignorando este filtro.")
        return None

def _opt_to_bool(opt, true_label, false_label):
    if opt == true_label:
        return True
    if opt == false_label:
        return False
    return None

# ============================================================
# üöÄ EXECU√á√ÉO DA PESQUISA
# ============================================================

if executar:
    st.info("Executando consulta ao PNCP. Isso pode levar alguns segundos...")

    # Converte campos de texto para tipos adequados
    cod_item = _parse_int_or_none(cod_item_str, "C√≥digo do item de cat√°logo")
    unidade_orgao_int = _parse_int_or_none(unidade_orgao, "C√≥digo da unidade do √≥rg√£o")
    codigo_classe = _parse_int_or_none(codigo_classe_str, "C√≥digo da classe")
    codigo_grupo = _parse_int_or_none(codigo_grupo_str, "C√≥digo do grupo")
    preco_max = _parse_float_or_none(preco_max_str, "Pre√ßo m√°ximo da contrata√ß√£o")

    # Converte selects booleanos
    tem_resultado = _opt_to_bool(
        tem_resultado_opt,
        "Somente com resultado",
        "Somente sem resultado",
    )
    bps = _opt_to_bool(
        bps_opt,
        "Somente BPS verdadeiro",
        "Somente BPS falso",
    )
    mpn = _opt_to_bool(
        mpn_opt,
        "Somente com margem",
        "Somente sem margem",
    )

    # Mapeia Material/Servi√ßo
    if material_ou_servico == "Material (M)":
        mos = "M"
    elif material_ou_servico == "Servi√ßo (S)":
        mos = "S"
    else:
        mos = ""

    with st.spinner("Consultando API do PNCP e gerando arquivos..."):
        excel_bytes, html_string, meta = pncp_backend.executar_pesquisa_e_gerar_arquivos(
            cod_item_catalogo=cod_item,
            orgao_cnpj=orgao_cnpj,
            unidade_orgao=unidade_orgao_int,
            situacao_item=situacao_item,
            material_ou_servico=mos,
            codigo_classe=codigo_classe,
            codigo_grupo=codigo_grupo,
            cod_fornecedor=cod_fornecedor,
            tem_resultado=tem_resultado,
            bps=bps,
            margem_pref_normal=mpn,
            codigo_ncm=codigo_ncm,
            preco_maximo=preco_max,  # Adicionado o novo par√¢metro
            nome_base_saida=nome_base or None,
        )

    # ========================================================
    # üìä APRESENTA√á√ÉO DOS RESULTADOS
    # ========================================================
    base = meta.get("nome_base", "pncp_pesquisa")

    # Resumo dos filtros efetivos aplicados
    st.markdown("### Resumo dos filtros aplicados")
    filtros_efetivos = meta.get("filtros_efetivos", {})
    if filtros_efetivos:
        st.json(filtros_efetivos)
    else:
        st.caption("Nenhum filtro adicional foi aplicado al√©m do per√≠odo de 12 meses.")

    if not excel_bytes:
        # N√£o h√° dados suficientes para montar Excel, mas o HTML ainda √© √∫til
        st.warning(
            "Nenhum dado foi encontrado para os filtros informados no per√≠odo considerado. "
            "Ainda assim, uma nota t√©cnica foi gerada registrando a tentativa de pesquisa "
            "no PNCP e os filtros utilizados."
        )

        # Download do HTML mesmo sem Excel
        st.download_button(
            label="‚¨áÔ∏è Baixar nota t√©cnica em HTML",
            data=html_string.encode("utf-8"),
            file_name=f"{base}.html",
            mime="text/html",
        )

        st.subheader("Pr√©-visualiza√ß√£o da nota t√©cnica")
        st.components.v1.html(html_string, height=700, scrolling=True)

    else:
        st.success("Pesquisa conclu√≠da com sucesso!")

        # Abas para organizar √°rea de resultados
        tab_downloads, tab_preview = st.tabs(["üìÇ Downloads", "üìù Nota t√©cnica (visualiza√ß√£o)"])

        with tab_downloads:
            st.markdown("#### Arquivos gerados")

            # Download da planilha
            st.download_button(
                label="‚¨áÔ∏è Baixar planilha Excel",
                data=excel_bytes,
                file_name=f"{base}.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            )

            # Download do HTML
            st.download_button(
                label="‚¨áÔ∏è Baixar nota t√©cnica em HTML",
                data=html_string.encode("utf-8"),
                file_name=f"{base}.html",
                mime="text/html",
            )

            st.caption("Anexe esses arquivos √† instru√ß√£o processual (por exemplo, no SEI).")

        with tab_preview:
            st.subheader("Visualiza√ß√£o da nota t√©cnica")
            st.components.v1.html(html_string, height=700, scrolling=True)
